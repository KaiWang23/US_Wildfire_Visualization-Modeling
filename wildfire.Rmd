---
title: "Wildfire"
author: "Peppa pig"
date: "12/10/2017"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
library(data.table)
library(RSQLite)
library(dbplyr)
library(dplyr)
library(purrr)
library(ggmap)
library(ggplot2)
library(ggthemes)
library(animation)
library(leaflet)
library(dbplyr)
library(caret)
library(rpart.plot)
library(knitr)
library(chron)
library(kableExtra)
library(date)
library(lubridate)
library(shiny)
library(shinycssloaders)
library(RColorBrewer)
library(scales)
library(lattice)
```


```{r save fires/firesplot}
#download dataset and remove zip file afterwards
download.file(url = "https://storage.googleapis.com/kaggle-datasets/2478/4139/FPA_FOD_20170508.sqlite.zip?GoogleAccessId=web-data@kaggle-161607.iam.gserviceaccount.com&Expires=1513189819&Signature=myp%2BB6XkMNUOfxgOsXoJbjzfSigsiX1Ds9wa8datVuulb7qk8hr5vaDh6S%2Fim9%2FygU7V%2Fpgk%2Fw%2FiPNduZsS7%2F6BUu7Lv3TSfIhPib%2B%2F0y4iCpoiii2dc1T%2B%2F2e4qY0E74yaPRgVKDQcjj1CL%2F0gF55JLr0QdkwoY5qnSt09w%2B%2B%2Bg8ZVn5jvPslhvxZDUcDlDVZdB0O%2BSdrZyu%2Flh8prBw2v2TZAzhylhok0WfbqU4MGLnGqLDa89Nf%2Fhtk%2Ba3KzadSLm04Eiv7jIh2%2FTpaYfqLPjelAHcj1KQrqjs1EK9DjLHuIPpXz2Y%2BnHM3ZLnM2iGnTRMnp5LtHd%2BQNs9GscrA%3D%3D", destfile = "data.zip")

unzip("data.zip")
file.remove("data.zip")

conn <- dbConnect(SQLite(), "FPA_FOD_20170508.sqlite")

# pull the fires table into RAM
fires <- tbl(conn, "Fires") %>% collect()

dbDisconnect(conn)

print(object.size(fires), units = 'Gb')

fires = fires %>% 
  select(FOD_ID, FIRE_YEAR, DISCOVERY_DATE, DISCOVERY_DOY, DISCOVERY_TIME, STAT_CAUSE_CODE, STAT_CAUSE_DESCR, CONT_DATE, CONT_DOY, CONT_TIME, FIRE_SIZE, FIRE_SIZE_CLASS, LATITUDE, LONGITUDE, OWNER_CODE, OWNER_DESCR, STATE, FIRE_NAME, SOURCE_REPORTING_UNIT_NAME, STAT_CAUSE_DESCR)

fires <- fires %>% arrange(DISCOVERY_DATE, CONT_DATE)

# Add codes for DC and Puerto Rico to the default state lists
state.abb <- append(state.abb, c("DC", "PR"))
state.name <- append(state.name, c("District of Columbia", "Puerto Rico"))

# Map the state abbreviations to state names so we can join with the map data
fires$region <- map_chr(fires$STATE, function(x) { tolower(state.name[grep(x, state.abb)]) })

fires$CONT_DATEymd <- as.Date(fires$CONT_DATE - 2458014.5, origin = '2017-09-18')

fires$DISCOVERY_DATEymd <- as.Date(fires$DISCOVERY_DATE - 2458014.5, origin = '2017-09-18')

firesplot <- fires %>% select(FIRE_SIZE, LATITUDE, LONGITUDE, CONT_DATEymd, DISCOVERY_DATEymd, STATE, region) %>% na.omit() %>% data.frame()

#save(fires, file = "~/STA523/Project-peppa_pig/fires.RData")

firesplot <- data.frame(firesplot)

#save(firesplot, file = "~/STA523/Project-peppa_pig/firesplot.RData")

# Get the us state map data
state_map <- map_data('state')

days <- apply(firesplot, 1, function(x){
  if(x[4] != x[5] ){
    return(seq(as.Date(x[5]), as.Date(x[4]), by="days"))
  }
})

notoneday = which(lapply(days,is.null)==F)
duration = lapply(days, length) %>% unlist()

newdataframe <- firesplot[rep(seq_len(nrow(firesplot)), duration), ]
newdataframe$DISCOVERY_DATEymd <- (do.call("c", days)) %>% as.Date(origin = '1970-01-01')

allday <- rbind(newdataframe[,-4], firesplot[-notoneday,-4])

allday <- allday %>% arrange(DISCOVERY_DATEymd) 

#save(allday, file = "~/STA523/Project-peppa_pig/allday.RData")
```


```{r load data}
load("~/STA523/Project-peppa_pig/fires.RData")
load("~/STA523/Project-peppa_pig/firesplot.RData")
load("~/STA523/Project-peppa_pig/allday.RData")
```

```{r plot function}
state_map <- map_data('state')


plotfire <- function(State, year, month){
  
  if (is.null(month) == T){
    subset <- which(substr(allday$DISCOVERY_DATEymd,1,4) == as.character(year) & 
                    allday$STATE == State)
  } else {
    subset <- which(substr(allday$DISCOVERY_DATEymd,1,4) == as.character(year) & 
                    as.numeric(substr(allday$DISCOVERY_DATEymd,6,7)) == month & 
                    allday$STATE == State)
  }

  plotdata <- allday[subset, ]
  npoints<- length(unique(plotdata$DISCOVERY_DATEymd))
  
  if (npoints == 0){
    stop("Safe without a wildfire within this period")
  } else {
    p0 <- plotdata %>% 
    select(region) %>%
    left_join(state_map, by = 'region') %>%
    ggplot(aes(x = long, y = lat)) + 
    geom_polygon(fill= "lightblue") + 
    theme_map() + 
    coord_map('albers', lat0=30, lat1=40)+ guides(fill=FALSE) +
    ggtitle(paste0(State,sep="  ",sep='Year:', year, sep="  ", sep='Month:', month)) + 
    theme(plot.title = element_text(hjust = 0.5))
    
    for(i in 1:npoints){
    date <- as.Date(plotdata[1, 4]) + i - 1
    take_df <- plotdata[which(plotdata$DISCOVERY_DATEymd == date), ]
    p <- p0+ geom_point(
      aes(x=LONGITUDE, y=LATITUDE, colour=FIRE_SIZE, size=FIRE_SIZE), 
      data=take_df, alpha=.5, na.rm = T)  + theme(legend.position="none")+
      scale_color_gradient(low="red", high="dark red") +
      ggtitle(date)
    print(p)
  }
  }
}

#model for prediction
getTree=function(state.name,year,month,day_of_week,open=T){
  
  if(open){
    fires.state=fires[fires$STATE==state.name,]
    df.return=fires.state%>%
      select(c(FIRE_NAME,STAT_CAUSE_DESCR,LATITUDE,LONGITUDE,DISCOVERY_DATE,FIRE_SIZE))%>%
      mutate(DATE=as.Date(DISCOVERY_DATE-2458014.5,origin= '2017-09-18'))%>%
      mutate(YEAR=as.numeric(format(as.Date(DATE),"%Y")))%>%
      mutate(MONTH=as.numeric(format(as.Date(DATE),"%m")))%>%
      mutate(DAY_OF_WEEK=as.numeric(wday(as.Date(DATE,'%Y-%m-%d'))))%>%
      mutate(CAUSE_RECODE = ifelse(STAT_CAUSE_DESCR %in% c("Lightning"), "nature",
                          ifelse(STAT_CAUSE_DESCR %in% c("Arson"), "malicious",
                                ifelse(STAT_CAUSE_DESCR %in% c("Missing/Undefined","Miscellaneous"), "other",
                                       "Accidental"))))%>%
      filter(YEAR==year)%>%
      filter(MONTH==month)%>%
      filter(DAY_OF_WEEK==day_of_week)%>%
      select(LONGITUDE,LATITUDE,FIRE_SIZE,FIRE_NAME,STAT_CAUSE_DESCR,CAUSE_RECODE)
    
    return(df.return)
  }
  
  if(!is.null(state.prev) && state.name==state.prev){
    rfmodel=model.prev
    fires.state=dataset.prev
  }
  else{
    fires.state=fires[fires$STATE==state.name,]

    if(nrow(fires.state)<5000){
     fires.sample=fires.state
    }else{
     p=5000/nrow(fires.state)
     sampling.index=sample(c(TRUE,FALSE),nrow(fires.state), replace=TRUE, prob = c(p,1-p))
     fires.sample=fires.state[sampling.index,]
    }

#select the variables we would like to use and tansform them into appropriate format
fires.sample=fires.sample%>%
  select(c(STAT_CAUSE_DESCR,LATITUDE,LONGITUDE,DISCOVERY_DATE,FIRE_SIZE))%>%
  mutate(DATE=as.Date(DISCOVERY_DATE-2458014.5,origin= '2017-09-18'))%>%
  mutate(YEAR=as.numeric(format(as.Date(DATE),"%Y")))%>%
  mutate(MONTH=as.numeric(format(as.Date(DATE),"%m")))%>%
  mutate(DAY_OF_WEEK=as.numeric(wday(as.Date(DATE,'%Y-%m-%d'))))%>%
  mutate(CAUSE_RECODE = ifelse(STAT_CAUSE_DESCR %in% c("Lightning"), "nature",
                          ifelse(STAT_CAUSE_DESCR %in% c("Arson"), "malicious",
                                ifelse(STAT_CAUSE_DESCR %in% c("Missing/Undefined","Miscellaneous"), "other",
                                       "Accidental"))))%>%
  select(-c(DISCOVERY_DATE,DATE,STAT_CAUSE_DESCR))
  
#change classes of some variables to factor
factornames=colnames(fires.sample)[!colnames(fires.sample) %in% c("LONGITUDE","LATITUDE","FIRE_SIZE")]
fires.sample[factornames] = lapply(fires.sample[factornames], factor)

#create training data frame
predictors=colnames(fires.sample)[!colnames(fires.sample) %in% c("CAUSE_RECODE")]

x.train=fires.sample[,predictors]
y.train=fires.sample$CAUSE_RECODE


#random forest
tr.control=trainControl(method="cv",number=3)

rfmodel <- train(x = x.train,
                 y = y.train,
                 method = 'rf',
                 tuneLength = 3,
                 ntree = 2,
                 trControl = tr.control)

model.prev<<-rfmodel
state.prev<<-state.name
dataset.prev<<-fires.state
}

x.train.new=fires.state%>%
  select(c(FIRE_NAME,STAT_CAUSE_DESCR,LATITUDE,LONGITUDE,DISCOVERY_DATE,FIRE_SIZE))%>%
  mutate(DATE=as.Date(DISCOVERY_DATE-2458014.5,origin= '2017-09-18'))%>%
  mutate(YEAR=as.numeric(format(as.Date(DATE),"%Y")))%>%
  mutate(MONTH=as.numeric(format(as.Date(DATE),"%m")))%>%
  mutate(DAY_OF_WEEK=as.numeric(wday(as.Date(DATE,'%Y-%m-%d'))))%>%
  mutate(CAUSE_RECODE = ifelse(STAT_CAUSE_DESCR %in% c("Lightning"), "nature",
                          ifelse(STAT_CAUSE_DESCR %in% c("Arson"), "malicious",
                                ifelse(STAT_CAUSE_DESCR %in% c("Missing/Undefined","Miscellaneous"), "other",
                                       "Accidental"))))%>%
  select(-c(DISCOVERY_DATE,DATE))
  
#change classes of some variables to factor
factornames=colnames(x.train.new)[!colnames(x.train.new) %in% c("LONGITUDE","LATITUDE","FIRE_SIZE","FIRE_NAME","STAT_CAUSE_DESCR","CAUSE_RECODE")]
x.train.new[factornames] = lapply(x.train.new[factornames], factor)

x.train.new=x.train.new%>%
  filter(YEAR==year)%>%
  filter(MONTH==month)%>%
  filter(DAY_OF_WEEK==day_of_week)

preds=predict(rfmodel,x.train.new)

df.return=x.train.new%>%
  select(LONGITUDE,LATITUDE,FIRE_SIZE,FIRE_NAME,STAT_CAUSE_DESCR,CAUSE_RECODE)%>%
  mutate(CAUSE=preds)

return(df.return)

}
```


```{r Shiny}
#REFERENCE: https://shiny.rstudio.com/gallery/superzip-example.html

maps = c(
  "OpenTopoMap" = "OpenTopoMap",
  "OpenStreetMap" = "OpenStreetMap",
  "Esri.WorldTopoMap" = "Esri.WorldTopoMap",
  "Esri.WorldImagery" = "Esri.WorldImagery",
  "HERE.hybridDay" = "HERE.hybridDay",
  "NASAGIBS.ViirsEarthAtNight2012" = "NASAGIBS.ViirsEarthAtNight2012",
  "Stamen.Toner" = "Stamen.Toner",
  "Stamen.TonerLite" = "Stamen.TonerLite",
  "Stamen.TonerLines" = "Stamen.TonerLines",
  "CartoDB.Positron" = "CartoDB.Positron"
)

states = c(
  "All States" = "All",
  "Alabama" =	"AL",
  "Alaska" = "AK",
  "Arizona"	= "AZ",
  "Arkansas" = "AR",
  "California" = "CA",
  "Colorado" = "CO",
  "Connecticut" = "CT",
  "Delaware" = "DE",
  "District of Columbia" = "DC",
  "Florida" = "FL",
  "Georgia" = "GA",
  "Hawaii" = "HI",
  "Idaho" = "ID",
  "Illinois" = "IL",
  "Indiana" = "IN",
  "Iowa" = "IA",
  "Kansas" = "KS",
  "Kentucky" = "KY",
  "Louisiana" = "LA",
  "Maine" = "ME",
  "Maryland" = "MD",
  "Massachusetts" = "MA",
  "Michigan" = "MI",
  "Minnesota" = "MN",
  "Mississippi" = "MS",
  "Missouri" = "MO",
  "Montana" = "MT",
  "Nebraska" = "NE",
  "Nevada" = "NV",
  "New Hampshire" = "NH",
  "New Jersey" = "NJ",
  "New Mexico" = "NM",
  "New York" = "NY",
  "North Carolina" = "NC",
  "North Dakota" = "ND",
  "Ohio" = "OH",
  "Oklahoma" = "OK",
  "Oregon" = "OR",
  "Pennsylvania" = "PA",
  "Rhode Island" = "RI",
  "South Carolina" = "SC",
  "South Dakota" = "SD",
  "Tennessee" = "TN",
  "Texas" = "TX",
  "Utah" = "UT",
  "Vermont"	= "VT",
  "Virginia" = "VA",
  "Washington" = "WA",
  "West Virginia" = "WV",
  "Wisconsin" = "WI",
  "Wyoming"	= "WY"
)

state_latlong = read.csv("state_latlong.csv", stringsAsFactors = F, header = T)
state.prev=NULL
model.prev=NULL
dataset.prev=NULL


shinyApp(
  ui = navbarPage("US Wildfires", id="nav",

    tabPanel("Interactive map",
      div(class="outer",
  
        tags$head(includeCSS("styles.css")),
        leafletOutput("map", width="100%", height="100%"),
  
        absolutePanel(id = "controls", class = "panel panel-default", fixed = TRUE,
          draggable = TRUE, top = 60, left = "auto", right = 10, bottom = "auto",
          width = 330, height = "auto",
  
          h3("US Wildfires explorer"),
  
          selectInput("basemap", "Base Map", maps),
          selectInput("state", "States", states, selected = "All"),
          dateInput("datefrom", "Select the Start Date", value = "2015-12-15", min = "1992-01-01", max = "2015-12-31"),
          dateInput("dateto", "Select the End Date", value = "2015-12-31", min = "1992-01-01", max = "2015-12-31"),
          actionButton("button", "Search")
        ),
        absolutePanel(id = "plots", class = "panel panel-default", fixed = TRUE,
          draggable = TRUE, top = 60, left = 10, right = "auto", bottom = "auto",
          width = 400, height = "auto",
                    
          h3("Plot Explorer"),
          
          plotOutput("plot1", height = 200),
          plotOutput("plot2", height = 300)
        ),
  
        tags$div(id="cite",
          tags$em('Short, Karen C. 2017. Spatial wildfire occurrence data for the United States, 1992-2015 [FPA_FOD_20170508]. 4th Edition. Fort Collins, CO: Forest Service Research Data Archive. https://doi.org/10.2737/RDS-2013-0009.4')
        )
      )
    ),
  
    tabPanel("Data explorer",
    div(
      absolutePanel(id = "control1", class = "panel panel-default", fixed = TRUE,
          draggable = TRUE, top = 60, left = "auto", right = 10, bottom = "auto",
          width = 330, height = "auto",
  
          h3("US Wildfires explorer"),
  
          selectInput("State", "State Abbreviation", choices = state.abb, selected = state.abb[33]),
          br(),
          sliderInput("year", "Year", min = 1992, max = 2015, value = 1992),
          br(),
          sliderInput("month","Month", min = 1, max = 12, value = 1),
          br(),
          sliderInput("d.of.w", "Day of Week", min =1, max=7,value=1),
          br(),
          actionButton("go2", "Predict Cause!")
          ), 
       withSpinner(leafletOutput('interactive_map'), type=1)
      )
    ),
    
    tabPanel("Get Gif",
    div(
      absolutePanel(id = "control2", class = "panel panel-default", fixed = TRUE,
          draggable = TRUE, top = 300, left = "auto", right = 10, bottom = "auto",
          width = 330, height = "auto",
          h3("US Wildfires explorer"),
  
          selectInput("S", "State Abbreviation", choices = state.abb, selected = state.abb[33]),
          br(),
          sliderInput("Y", "Year", min = 1992, max = 2015, value = 1992),
          br(),
          sliderInput("M","Month", min = 1, max = 12, value = 1),
          br(),
          actionButton("go", "Get Gif!")
          ), 
       imageOutput('animated_image')
      )
    ),
    conditionalPanel("false", icon("crosshair"))
  )
  ,
  server = function(input, output, session){
    
    observeEvent(input$button,{
      
      fires.df = fires %>% filter((input$datefrom <= DISCOVERY_DATEymd)&(DISCOVERY_DATEymd <= input$dateto))
      if (input$state != "All"){
        fires.df = fires.df %>% filter(STATE == input$state)
      }
      
      popups.df = fires.df %>% 
        mutate(pop = paste(paste0("<b> Global Unique ID:", FOD_ID,"</b>"),
                           paste0("Discovery Date: ", DISCOVERY_DATEymd),
                           paste0("Source Reporting Unit: ", SOURCE_REPORTING_UNIT_NAME),
                           paste0("Fire Size: ", FIRE_SIZE),
                           paste0("Fire Class: ", FIRE_SIZE_CLASS),
                           paste0("Cause: ", STAT_CAUSE_DESCR),
                           sep = "<br/>"),
               la = paste0(LATITUDE, "°N, ", abs(LONGITUDE), "°W")) %>% 
        select(LONGITUDE, LATITUDE, pop, la)
      
      output$plot1 <- renderPlot({
        ggplot(fires.df, aes(x = DISCOVERY_DATEymd, y = FIRE_SIZE)) + 
          geom_point(col = "purple") +
          labs(title = "Fire Size by Date",x = "Date",
               y = "Fire Size (acres)") + theme_bw()
      })
      
      output$plot2 <- renderPlot({
        fires.df %>% group_by(STAT_CAUSE_DESCR) %>%
          summarize(total_size = sum(FIRE_SIZE, na.rm = TRUE)) %>%
          ggplot(aes(x = STAT_CAUSE_DESCR, y = total_size)) + 
          geom_bar(stat = 'identity', fill = 'orange') +
          labs(title = "Total Wildfire Size by Cause",x = "Cause",
               y = "Fire Size (acres)") + theme_bw() +
          theme(axis.text.x = element_text(angle = 90, hjust = 1))
      })
      
      
      stateBy = input$state
      mapBy = input$basemap
      
      maplat = 37.45 
      maplong = -93.85
      zoom = 4
      
      if (stateBy != "All"){
        maplat = state_latlong$Latitude[state_latlong$State == stateBy]
        maplong = state_latlong$Longitude[state_latlong$State == stateBy]
        zoom = 6
      }
      
      
      output$map <- renderLeaflet({
        leaflet() %>% setView(lng = maplong, lat = maplat, zoom = zoom) %>%
          addProviderTiles(mapBy,
                           options = providerTileOptions(noWrap = TRUE)) %>%
          addMarkers(lng = ~LONGITUDE, lat = ~LATITUDE, popup = ~pop, label = ~la, data = popups.df) })
      
         


      
      
    })
    
        
    output$interactive_map= renderLeaflet({
        fires.aux=getTree("NC","1992",1,1)
        fires.aux %>%
            leaflet() %>% 
            addTiles() %>%
            addMarkers(
              ~LONGITUDE,
              ~LATITUDE,
              popup = ~paste(sep = "<br/>",
              paste("Fire Name:",FIRE_NAME),
              paste("Fire Size:",FIRE_SIZE,"acres"),
              paste("Actual Cause:",CAUSE_RECODE),
              paste("Actual Cause In Specific:", STAT_CAUSE_DESCR)))
      })
    observeEvent(input$go2, {
    output$interactive_map =renderLeaflet(
      {
        fires.aux=getTree(isolate(input$State),isolate(as.numeric(input$year)),isolate(as.numeric(input$month)),isolate(as.numeric(input$d.of.w)),open = FALSE)
        
        fires.aux %>%
            leaflet() %>% 
            #setView(lat = -0.900653, lng = -78.467834, zoom = 7) %>% 
            addTiles() %>%
            addMarkers(
              ~LONGITUDE,
              ~LATITUDE,
              popup = ~paste(sep = "<br/>",
              paste("Fire Name:",FIRE_NAME),
              paste("Fire Size:",FIRE_SIZE,"acres"),
              paste("Predicted Cause:",CAUSE),
              paste("Actual Cause:",CAUSE_RECODE),
              paste("Actual Cause In Specific:", STAT_CAUSE_DESCR))

            )
      }
    )
    })
    
    output$animated_image <- renderImage({
      outfile <- tempfile(fileext='.gif')
      saveGIF(plotfire("NC", "1992", "1"), movie.name = "outfile.gif")
      contentType = 'image/gif'
      list(src="outfile.gif")
    }, deleteFile = T)    
  
    observeEvent(input$go, {
    output$animated_image <- renderImage({
      outfile <- tempfile(fileext='.gif')
      saveGIF(plotfire(isolate(input$S), isolate(input$Y), isolate(input$M)), movie.name = "outfile.gif")
      contentType = 'image/gif'
      list(src="outfile.gif")
    }, deleteFile = T)})    
    
    
    
  }
)
```