---
title: "Wildfire"
author: "Peppa pig"
date: "12/10/2017"
output: pdf_document
---

```{r setup, include=FALSE}
library(data.table)
library(RSQLite)
library(dbplyr)
library(dplyr)
library(purrr)
library(ggplot2)
```

```{r}
download.file(url = "https://storage.googleapis.com/kaggle-datasets/2478/4139/FPA_FOD_20170508.sqlite.zip?GoogleAccessId=web-data@kaggle-161607.iam.gserviceaccount.com&Expires=1513189819&Signature=myp%2BB6XkMNUOfxgOsXoJbjzfSigsiX1Ds9wa8datVuulb7qk8hr5vaDh6S%2Fim9%2FygU7V%2Fpgk%2Fw%2FiPNduZsS7%2F6BUu7Lv3TSfIhPib%2B%2F0y4iCpoiii2dc1T%2B%2F2e4qY0E74yaPRgVKDQcjj1CL%2F0gF55JLr0QdkwoY5qnSt09w%2B%2B%2Bg8ZVn5jvPslhvxZDUcDlDVZdB0O%2BSdrZyu%2Flh8prBw2v2TZAzhylhok0WfbqU4MGLnGqLDa89Nf%2Fhtk%2Ba3KzadSLm04Eiv7jIh2%2FTpaYfqLPjelAHcj1KQrqjs1EK9DjLHuIPpXz2Y%2BnHM3ZLnM2iGnTRMnp5LtHd%2BQNs9GscrA%3D%3D", destfile = "data.zip")

unzip("data.zip")
file.remove("data.zip")

conn <- dbConnect(SQLite(), "FPA_FOD_20170508.sqlite")

# pull the fires table into RAM
fires <- tbl(conn, "Fires") %>% collect()

print(object.size(fires), units = 'Gb')

fires <- fires %>% arrange(DISCOVERY_DATE, CONT_DATE)

fires$CONT_DATEymd <- as.Date(fires$CONT_DATE - 2458014.5, origin = '2017-09-18')

fires$DISCOVERY_DATEymd <- as.Date(fires$DISCOVERY_DATE - 2458014.5, origin = '2017-09-18')

firesplot <- fires %>% select(FIRE_SIZE, LATITUDE, LONGITUDE, CONT_DATEymd, DISCOVERY_DATEymd) %>% 
  na.omit() %>% data.frame()

load("~/STA523/Project-peppa_pig/fireplot.RData")

firesplot <- data.frame(firesplot)

days <- apply(firesplot, 1, function(x){
  if(x[4]!=x[5]){
    return(seq(as.Date(x[5]), as.Date(x[4]), by="days"))
  }
})

notoneday = which(lapply(days,is.null)==F)
duration = lapply(days, length) %>% unlist()

newdataframe <- firesplot[rep(seq_len(nrow(firesplot)), duration), ]
newdataframe$DISCOVERY_DATEymd <- (do.call("c", days)) %>% as.Date(origin = '1970-01-01')

allday <- rbind(newdataframe[,-4], firesplot[-notoneday,-4])

allday <- allday %>% arrange(DISCOVERY_DATEymd) 

year1992 <- allday[substr(allday$DISCOVERY_DATEymd,1,4) == '1992',]


library(ggmap)
library(animation)

npoints<- length(unique(year1992$DISCOVERY_DATEymd))

map<-get_map(location='united states', zoom=4, maptype = "terrain",
             source='google',color='color')

plotfire <- function(){
  for(i in 1:npoints){
    date <- as.Date(year1992[1, 4]) + i - 1
    take_df <- year1992[which(year1992$DISCOVERY_DATEymd == date), ]
    p <- ggmap(map) + geom_point(
      aes(x=LONGITUDE, y=LATITUDE, colour=FIRE_SIZE, size=FIRE_SIZE), 
      data=take_df, alpha=.5, na.rm = T)  + 
      scale_color_gradient(low="yellow", high="dark red") +
      ggtitle(date)
    print(p)
  }
}

saveGIF(plotfire())



```

